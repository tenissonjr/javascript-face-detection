<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Teste de Câmeras</title>


  <link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
	integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk"
    crossorigin="anonymous">
    
    <style>
        h2 {
        color: blue;
        }
    </style>

</head>
<body>

<div class="container">
    <div class="row">
        <div class="col-md-12"><h1>Teste de seleção de câmeras:</h1>
        </div>
    </div>   

    <div class="row">
        <div class="col-md-6" ><h2> Câmera Visitante</h2> </div>
        <div class="col-md-6" > <h2>Câmera Documento</h2> </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <video id="camera-visitante" width="450" height="600" preload autoplay loop muted></video>
        </div>
        <div class="col-md-6">
            <video id="camera-documento" width="450" height="600" preload autoplay loop muted></video>
        </div>
    </div>   

    <div class="row">
        <div class="col-md-6">
            <select id="listaCamerasVisitante">
                <option></option>
            </select>
            &nbsp;<button id="btnSelecionarCameraVisitante" class="btn btn-primary">Selecionar</button>
        </div>
        <div class="col-md-6">
            <select id="listaCamerasDocumento">
                <option></option>
            </select>
            &nbsp;<button id="btnSelecionarCameraDocumento"class="btn btn-primary" >Selecionar</button>
        </div>
    </div>   


</div>        



  <script>


const videoVisitante                = document.getElementById('camera-visitante');
const btnSelecionarCameraVisitante  = document.getElementById('btnSelecionarCameraVisitante');
const listaCamerasVisitante         = document.getElementById('listaCamerasVisitante');
let currentStreamCameraVisitante;


const videoDocumento                = document.getElementById('camera-documento');
const btnSelecionarCameraDocumento  = document.getElementById('btnSelecionarCameraDocumento');
const listaCamerasDocumento         = document.getElementById('listaCamerasDocumento');
let currentStreamCameraDocumento;

function stopMediaTracks(stream) {
  stream.getTracks().forEach(track => {
    track.stop();
  });
}

function atualizarListaCamerasDisponiveisVisitante(mediaDevices){
  listaCamerasVisitante.innerHTML = '';
  listaCamerasVisitante.appendChild(document.createElement('option'));
  let count = 1;
  mediaDevices.forEach(mediaDevice => {
    if (mediaDevice.kind === 'videoinput') {
      const option = document.createElement('option');
      option.value = mediaDevice.deviceId;
      const label = mediaDevice.label || `Camera ${count++}`;
      const textNode = document.createTextNode(label);
      option.appendChild(textNode);
      listaCamerasVisitante.appendChild(option);
    }
  });
}

function atualizarListaCamerasDisponiveisDocumento(mediaDevices){
  listaCamerasDocumento.innerHTML = '';
  listaCamerasDocumento.appendChild(document.createElement('option'));
  let count = 1;
  mediaDevices.forEach(mediaDevice => {
    if (mediaDevice.kind === 'videoinput') {
      const option = document.createElement('option');
      option.value = mediaDevice.deviceId;
      const label = mediaDevice.label || `Camera ${count++}`;
      const textNode = document.createTextNode(label);
      option.appendChild(textNode);
      listaCamerasDocumento.appendChild(option);
    }
  });
}


function atualizarListaCamerasDisponiveis(mediaDevices) {
    atualizarListaCamerasDisponiveisVisitante(mediaDevices);
    atualizarListaCamerasDisponiveisDocumento(mediaDevices);
}

btnSelecionarCameraVisitante.addEventListener('click', event => {
    if (typeof currentStreamCameraVisitante !== 'undefined') {
    stopMediaTracks(currentStreamCameraVisitante);
  }
  const videoConstraints = {};
  if (listaCamerasVisitante.value === '') {
    videoConstraints.facingMode = 'environment';
  } else {
    videoConstraints.deviceId = { exact: listaCamerasVisitante.value };
  }
  const constraints = {
    video: videoConstraints,
    audio: false
  };
  navigator.mediaDevices
    .getUserMedia(constraints)
    .then(stream => {
        currentStreamCameraVisitante = stream;
        videoVisitante.srcObject = stream;
      return navigator.mediaDevices.enumerateDevices();
    })
    .then(atualizarListaCamerasDisponiveis)
    .catch(error => {
      console.error(error);
    });
});


btnSelecionarCameraDocumento.addEventListener('click', event => {
    if (typeof currentStreamCameraDocumento !== 'undefined') {
    stopMediaTracks(currentStreamCameraDocumento);
  }
  const videoConstraints = {};
  if (listaCamerasDocumento.value === '') {
    videoConstraints.facingMode = 'environment';
  } else {
    videoConstraints.deviceId = { exact: listaCamerasDocumento.value };
  }
  const constraints = {
    video: videoConstraints,
    audio: false
  };
  navigator.mediaDevices
    .getUserMedia(constraints)
    .then(stream => {
        currentStreamCameraDocumento = stream;
    videoDocumento.srcObject = stream;
      return navigator.mediaDevices.enumerateDevices();
    })
    .then(atualizarListaCamerasDisponiveis)
    .catch(error => {
      console.error(error);
    });
});


navigator.mediaDevices.enumerateDevices().then(atualizarListaCamerasDisponiveis);


  </script>

</body>
</html>
