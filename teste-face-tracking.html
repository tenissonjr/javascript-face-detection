<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>tracking.js - face with camera</title>


  <script src="lib/tracking.js-master/build/tracking-min.js"></script>
  <script src="lib/tracking.js-master/build/data/face.js"></script>

  <link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
	integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk"
	crossorigin="anonymous">

  <link rel="stylesheet" href="assets/meter.css">

  
</head>
<body>




    
    <div class="container">

      <div class="row">
        <div class="col-md-12">
          <h2 class="display-10">Teste de fotografia de rosto:</h2>
        </div>
      </div>    

        <div class="row">
          <div class="col-md-8">
            <div class="demo-frame">
              <div class="demo-container">
                <video id="video"   width="640" height="480" preload autoplay loop muted></video>
                <canvas id="canvas" width="640" height="480"></canvas>
                <canvas id="foto"   width="640" height="480" style="visibility: hidden"></canvas>
              </div>
            </div>
            </div>
          <div class="col-md-6"></div>
        </div>
        

        <div class="row">
          <div class="col-md-4">
            Percentual Face/Imagem Identificado: 
          </div>  
          <div class="col-md-2">
            <b><labe id="percentualFace"></labe>  </b>
          </div>  
        </div>  

        <div class="row">
            <div class="col-md-4"> 
              Percentual mínimo para captura de foto  : 
            </div>  
          <div class="col-md-4">
            <b><span id="corte">0</span></b> %
            <input id="percentualMinimo" type="range" min="0" max="100" value="0"> 
          </div> 
        </div>  

        <div class="row">
          <div class="col-md-4"> 
            Percentual relação ao mínimo obrigatório : 
          </div>  
          <div class="col-md-8">
            <b><labe id="percentualMeter"></labe>  </b>
          </div>  
        </div>  
        <div class="row">
          <div class="col-md-12"></div>
            <meter id="meter" min="0" max="100" low="25" high="75" optimum="100" value="10"></meter>
          </div>
        </div>

        <div class="row">
          <div class="col-md-8 text-center">
            <button id="btnFotografarFace" type="button" class="btn btn-primary button-margin-top" >
              <span  class="fas fa-camera">Fotografar</span></button>
            <button id="btnReiniciarFotografarFace" type="button" class="btn btn-secondary button-margin-top button-margin-left" >
              <span  class="fas fa-redo">Reiniciar</span></button>
          </div>
          <div class="col-md-4"></div>
        </div>

        <div class="row">
          <div class="col-md-4">&nbsp; </div>            
          <div class="col-md-8">&nbsp;<b><label id="mensagemCapturaFoto"></label></b></div>  
        </div>  
        

      </div>
  </body>
  

  <script>


      const video         = document.getElementById('video');
      const canvas        = document.getElementById('canvas');
      var context         = canvas.getContext('2d');

      const percentualFace  = document.querySelector('#percentualFace');
      const percentualMeter = document.querySelector('#percentualMeter');

      const meter = document.querySelector('#meter');
      const btnFotografar       = document.querySelector('#btnFotografarFace')	
      const mensagemCapturaFoto = document.querySelector('#mensagemCapturaFoto')	


      const percentualMinimo = document.getElementById("percentualMinimo");
      const  corte = document.getElementById("corte");

      corte.innerHTML = percentualMinimo.value; // Display the default slider value
      // Update the current slider value (each time you drag the slider handle)
      percentualMinimo.oninput = function() {
        corte.innerHTML = this.value;
      }

    function round(value, decimals) {
      return  Number(Math.round(value+'e'+decimals)+'e-'+decimals);
    }


    window.onload =  IdentificarRosto ;
    
    
    
    function IdentificarRosto() {

      var tracker = new tracking.ObjectTracker('face');
      tracker.setInitialScale(4);
      tracker.setStepSize(2);
      tracker.setEdgesDensity(0.1);

      tracking.track('#video', tracker, { camera: true });

      tracker.on('track', function(event) {
      context.clearRect(0, 0, canvas.width, canvas.height);


      if (parseFloat( percentualMinimo.value )==0){
        return ;
      }

      event.data.forEach( rect => destacarRostoIdentificado(rect));      

        if (event.data.length == 0){        
          mensagemCapturaFoto.innerHTML='Falha de captura. Nenhum rosto identificado.'
          btnFotografar.disabled = true;
        } else if (event.data.length > 1){
          mensagemCapturaFoto.innerHTML='Falha de captura. Mais de um rosto identificado.'
          btnFotografar.disabled = true;
        }
      });


    }

   function destacarRostoIdentificado(rect) {

        let  percentualFaceIdentificado =  round( (rect.width * rect.height) / (canvas.width*canvas.height) ,2)  *100 ;
        percentualFace.innerHTML=  percentualFaceIdentificado.toLocaleString("pt-BR", { maximumFractionDigits: 2, minimumFractionDigits: 2 })  +  ' %'

        let valPercentualMinimo  =   parseFloat( percentualMinimo.value );

          console.log("*percentualMinimo",valPercentualMinimo)
          console.log("percentualFaceIdentificado",percentualFaceIdentificado)

        let percentualMeterCalculado = Math.min(100.00 ,  percentualFaceIdentificado / valPercentualMinimo*100 );  

        
        console.log("percentualMeterCalculado",percentualMeterCalculado)

        percentualMeter.innerHTML=  percentualMeterCalculado.toLocaleString("pt-BR", { maximumFractionDigits: 2, minimumFractionDigits: 2 })  +  ' %'

        meter.value = percentualMeterCalculado ;


       if (percentualMeterCalculado < 100 ){
          context.strokeStyle = 'red';
          context.lineWidth = 2;
          mensagemCapturaFoto.innerHTML='Centralize e aproxime '
          btnFotografar.disabled = true;
       }  else{
          context.strokeStyle = 'green';
          context.lineWidth = 2;
          mensagemCapturaFoto.innerHTML=''
          btnFotografar.disabled = false;
       } 

       
          context.strokeRect(rect.x, rect.y, rect.width, rect.height);
          context.font = '11px Helvetica';
          context.fillStyle = "#fff";
          context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
          context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);

   }


  document.querySelector('#btnFotografarFace')	
		.addEventListener('click',()=>takepicture());

	document.querySelector('#btnReiniciarFotografarFace')	
	.addEventListener('click',()=>resetpicture());

  function takepicture(){

      let video = document.querySelector('#video');
      let canvas = document.querySelector('#canvas');
      let foto = document.querySelector('#foto');      

      video.style.visibility="hidden";

      var context = foto.getContext('2d');
    
      if (canvas.width && canvas.height) {
        foto.width = canvas.width;
        foto.height = canvas.height;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        //this.data = this.canvas.toDataURL("image/jpg");
        //this.photo.setAttribute("src", this.data);

        foto.style.visibility="";
      }




  }

  function resetpicture(){
    let video = document.querySelector('#video');
      let canvas = document.querySelector('#canvas');
      let foto = document.querySelector('#foto');      

      foto.style.visibility="hidden";
      video.style.visibility="";



}


  </script>

</body>
</html>
